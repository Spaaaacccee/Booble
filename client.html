<html>

<head>
  <title>Boob</title>
</head>
<link rel="stylesheet" href="./css/litera/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="./css/spinners/7-three-bounce.css" type="text/css">

<body>
  <div id="spinner" class="sk-three-bounce active">
    <div class="sk-child sk-bounce1"></div>
    <div class="sk-child sk-bounce2"></div>
    <div class="sk-child sk-bounce3"></div>
  </div>

  <div id="flex">
    <img src="./res/googlelogo.png" width="80" style="margin-bottom:20px">
    <h1>
  Which of the two countries search for <b id="keyword">this keyword</b> more?
</h1>
    <br/>
    <div id="main">
      <button id="b1" class="btn"></button>
      <button id="b2" class="btn"></button>
    </div>
    <div id="hints">
      <p id="hint1"></p>
      <p id="hint2"></p>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script>
    function getRandomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    var currentTopic = "Google";
    var nextTopicData;
    ready = new(function() {
      var _ready = true;
      var cache;
      this.setTrue = function() {
        _ready = true;
        if (cache != undefined) {
          cache();
          console.log("executing cache")
          cache = undefined;
        }
      };
      this.setFalse = function() {
        _ready = false
      };
      this.isReady = function() {
        return _ready
      };
      this.setCache = function(obj) {
        cache = obj;
      }
    })();

    var spinner = new(function() {
      var spin = $("#spinner");
      this.setNotReady = function() {
        spin.addClass("active");
      }
      this.setReady = function() {
        spin.removeClass("active")
      }
      this.isReady = function() {
        if (spin.hasClass("active")) {
          return false
        } else {
          return true
        }
      }
    })();

    function request(operation, data) {
      this.operation = operation;
      this.timeStamp = Date.now();
      this.data = data;
    }

    function init(callback) {
      recover()
      draw();
    };

    function next(callback) {
      if (ready.isReady()) {
        ready.setFalse();
        nextTopicData.then(function(e) {
          draw(e)
          if (getRandomInt(1, 4) == 4) {
            recover();
          } else {
            nextTopic(function() {
              ready.setTrue()
            })
          }
        })
      } else {
        console.log("not ready but will try again when ready")
        ready.setCache(function() {
          next(callback)
        });
      }
    }


    function draw(arr, callback) {
      spinner.setReady();

      function onButtonPress(s) {
        ["#b1", "#b2"]
        $.each(a, function(i, obj) {
          $(obj).off();
        })
        setTimeout(function() {
          next();
          spinner.setNotReady();
        }, 2000)
      }

      function onCorrect(s) {
        onButtonPress(s)
        s.addClass("correct");
      }

      function onIncorrect(s) {
        onButtonPress(s)
        s.addClass("incorrect");
      }
      try {
        var rand = getRandomInt(1, arr[0].default.geoMapData.length - 1)
        var a = ["#b1", "#b2"]
        $.each(a, function(i, obj) {
          $(obj).removeClass("correct incorrect");
        })
        if (getRandomInt(0, 1)) {
          a.reverse();
        }
        $(a[0]).text(arr[0].default.geoMapData[0].geoName).click(function() {
          onCorrect($(this))
        })
        $(a[1]).text(arr[0].default.geoMapData[rand].geoName).click(function() {
          onIncorrect($(this))
        })
        $("#keyword")[0].innerText = currentTopic;
      } catch (e) {
        recover()
      }
    }

    function xHR(data, callback) {
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          callback(JSON.parse(xhttp.responseText))
        }
      };
      xhttp.open("POST", "/fetch", true);
      data = data == undefined ? "" : JSON.stringify(data);
      xhttp.setRequestHeader("Content-Type", "application/json");
      xhttp.send(data);
      console.log(data);
    }

    function fetchData(operation, data, callback) {
      xHR(new request(operation, data), function(e) {
        callback(e);
      });
    }

    function apiCommand(operation, topic, callback) {
      return new Promise(function(res, rej) {
        fetchData(operation, {
          topic: topic || currentTopic
        }, function(e) {
          if (callback) callback(e);
          return res(e)
        })
      })
    }

    function trendingTopics(topic, callback) {
      return apiCommand("trending", topic, callback)
    }

    function interestByRegion(topic, callback) {
      return apiCommand("interestByRegion", topic, callback)
    }

    function randomWord(callback) {
      return apiCommand("randomWord", {}, callback)
    }

    function nextTopic(callback) {
      nextTopicData = new Promise(function(res, rej) {
        try {
          trendingTopics(currentTopic, function(e) {
            var rL = e.default.rankedList[0].rankedKeyword;
            try {
              currentTopic = rL[getRandomInt(3, rL.length - 1)].query;
            } catch (e) {
              recover();
            }
            fetchOnKeyword(currentTopic).then(function(e) {
              if (typeof callback != "undefined") callback();
              res(e);
            }, function(e) {
              recover()
            })
          })
        } catch (e) {
          recover();
        }
      });
    }

    function recover(callback) {
      console.log("recover!")
      spinner.setNotReady()
      randomWord(function(e) {

        currentTopic = e.word;
        nextTopicData = fetchOnKeyword(currentTopic)
        nextTopicData.then(function(e){nextTopic();ready.setTrue();spinner.setReady()});

      })
    }

    function fetchOnKeyword(keyword, callback) {
      return new Promise(function(res, rej) {
        trendingTopics(currentTopic, function(e) {
          try {
            var rL = e.default.rankedList[0].rankedKeyword;
            var promises = [interestByRegion(currentTopic), interestByRegion(rL[1].query), interestByRegion(rL[2].query)];
            Promise.all(promises).then(function(e) {
              if (typeof callback !== "undefined") callback();
              return res(e)
            })
          } catch (e) {
            recover();
          }
        })
      })
    }

    init()
  </script>
  <style>
    html,
    body {
      width: 100%;
      overflow: hidden;
    }

    #main .btn {
      transition: all 0.3s ease;
    }

    #flex {
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      flex-direction: column;
      padding: 20%;
      height: 100%;
    }

    #main {
      text-align: center;

    }

    .btn {
      cursor: pointer;
      background: black;
      font-weight: 600;
      color: white;
      border: none !important;
      outline: none !important;
    }

    .btn:hover {
      /*background: #444;*/
      box-shadow: 0 9px 28px rgba(0, 0, 0, 0.2), 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .btn.correct {
      background: #4cdb9d;
    }

    .btn.incorrect {
      background: #C0392B;
    }

    #spinner {
      display: none;
    }

    #spinner.active {
      position: fixed;
      top: 0;
      width: 100%;
      height: 100%;
      display: block;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 0;
      background: rgba(255, 255, 255, 0.5)
    }
  </style>
</body>

</html>
